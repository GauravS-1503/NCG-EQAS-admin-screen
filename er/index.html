<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex, nofollow">
  <title>mdsr run config</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/style.css?v=9">
  <link rel="stylesheet" href="../assets/mdsr_run_config.css?v=9">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="../assets/include.js?v=9" defer></script>

</head>
<body>

<!-- Top Bar -->
<div id="header"></div>

<!-- Layout -->
<div class="d-flex" id="contentArea">
  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar"></aside>


  <!-- Main Content -->
  <div class="main-content flex-grow-1 p-4" id="mainContent">
    <div class="d-flex align-items-center gap-2 mb-3 flex-wrap">
      <h5 class="text-uppercase mb-0" style="font-size: 1.2rem;">Run Configuration (ER)</h5>
    </div>


    <div class="bg-white p-3 rounded shadow-sm">
      <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle mb-0" id="mdsrTable">
          <thead class="table-light">
            <tr>
              <th style="width:70px;" class="text-center">Cores</th>
              <th style="width:50%;" class="text-center">Enable</th>
            </tr>
          </thead>
          <tbody id="mdsrTbody"></tbody>
        </table>
        <div class="d-flex align-items-center gap-2 mt-3 flex-wrap justify-content-end">
          <button class="btn btn-success" onclick="saveConfig()">
            <i class="bi bi-save me-1"></i>Save Config
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- NEW: Modal -->
<div class="modal fade" id="addBatchModal" tabindex="-1" aria-labelledby="addBatchLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form id="batchForm">
        <div class="modal-header">
          <h5 class="modal-title" id="addBatchLabel">Add Batch</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Batch No.</label>
              <input type="text" class="form-control" id="batchNo" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-control" id="startDate" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">End Date</label>
              <input type="date" class="form-control" id="endDate" required>
            </div>
          </div>

          <hr class="my-3">

          <div class="row g-3">
            <div class="col-12">
              <label class="form-label d-flex align-items-center justify-content-between">
                <span>Select Centres (multi-select)</span>
                <small class="text-muted" id="selCount">0 selected</small>
              </label>

              <!-- quick filter -->
              <input type="text" class="form-control mb-2" id="centreFilter" placeholder="Type to filter centres...">

              <!-- multi-select list -->
              <select multiple class="form-select" id="centreSelect" size="10"></select>

              <div class="form-text">Hold Ctrl/Cmd (or use mouse) to select multiple.</div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Batch</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
/* ---------- Helpers & Data ---------- */

// Demo list of 200 centres. Replace with your real list if you have one.
const ALL_CENTRES = Array.from({length: 200}, (_, i) => `Center ${i + 1}`);

// Keep data in-memory for now
let nextRowId = 1;                    // for unique collapse ids
const batches = [];                   // {id, batchNo, startDate, endDate, centres[]}

/* ---------- Build the modalâ€™s centre list ---------- */

function fillCentreSelect(filter = '') {
  const sel = document.getElementById('centreSelect');
  const f = filter.trim().toLowerCase();
  sel.innerHTML = '';
  ALL_CENTRES
    .filter(c => c.toLowerCase().includes(f))
    .forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      sel.appendChild(opt);
    });
  updateSelectedCount();
}

function updateSelectedCount() {
  const sel = document.getElementById('centreSelect');
  const count = Array.from(sel.selectedOptions).length;
  document.getElementById('selCount').textContent = `${count} selected`;
}

/* ---------- Table row rendering ---------- */

function renderTable() {
  const tbody = document.getElementById('batchTbody');
  tbody.innerHTML = '';

  batches.forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="text-center">
        <button class="btn btn-sm btn-outline-secondary" title="Edit (coming soon)" disabled>
          <i class="bi bi-pencil-square"></i>
        </button>
      </td>
      <td>${row.batchNo}</td>
      <td>${row.startDate}</td>
      <td>${row.endDate}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse"
                data-bs-target="#centres-${row.id}" aria-expanded="false" aria-controls="centres-${row.id}">
          Show list (${row.centres.length})
        </button>
      </td>
      <td>
        <button class="btn btn-sm btn-outline-success" onclick="downloadCentresCSV(${row.id})">
          <i class="bi bi-download me-1"></i>Download CSV
        </button>
      </td>
    `;
    tbody.appendChild(tr);

    // Collapsible detail row (note colspan=6 to span the new column)
    const tr2 = document.createElement('tr');
    tr2.innerHTML = `
      <td colspan="6" class="p-0">
        <div class="collapse" id="centres-${row.id}">
          <div class="p-3">
            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-2">
              ${row.centres.map(c => `<div class="col"><span class="badge bg-light text-dark w-100 text-start">${c}</span></div>`).join('')}
            </div>
          </div>
        </div>
      </td>
    `;
    tbody.appendChild(tr2);
  });
}

function downloadCentresCSV(rowId) {
  const row = batches.find(b => b.id === rowId);
  if (!row) return;

  // Build CSV (includes batch metadata and one centre per line)
  const header = ['Batch','Start Date','End Date','Centre'];
  const lines = row.centres.length
    ? row.centres.map(c => [row.batchNo, row.startDate, row.endDate, c])
    : [[row.batchNo, row.startDate, row.endDate, '']];

  const csv = [header, ...lines]
    .map(arr => arr.map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))
    .join('\r\n');

  // Trigger download
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `batch_${row.batchNo}_centres.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
/* ---------- Event wiring ---------- */

document.addEventListener('DOMContentLoaded', () => {
  // Seed the select
  fillCentreSelect();

  // Filter centres as user types
  document.getElementById('centreFilter').addEventListener('input', (e) => {
    fillCentreSelect(e.target.value);
  });

  // Track multi-select count
  document.getElementById('centreSelect').addEventListener('change', updateSelectedCount);

  // Handle form submit -> create row
  document.getElementById('batchForm').addEventListener('submit', (e) => {
    e.preventDefault();

    const batchNo = document.getElementById('batchNo').value.trim();
    const startDate = document.getElementById('startDate').value;
    const endDate   = document.getElementById('endDate').value;

    // Collect selected centres
    const centres = Array.from(document.getElementById('centreSelect').selectedOptions).map(o => o.value);

    // Basic validation
    if (!batchNo || !startDate || !endDate) return;
    if (new Date(endDate) < new Date(startDate)) {
      alert('End Date must be on/after Start Date.');
      return;
    }

    const id = nextRowId++;
    batches.push({ id, batchNo, startDate, endDate, centres });

    // Re-render table
    renderTable();

    // Reset form & close modal
    e.target.reset();
    fillCentreSelect();                // rebuild full list
    const modal = bootstrap.Modal.getInstance(document.getElementById('addBatchModal'));
    modal.hide();
  });
});

/* ---------- (Existing utilities you had) ---------- */
function downloadExcel() {
  const link = document.createElement("a");
  link.href = "assets/registrations.xlsx";
  link.download = "registrations.xlsx";
  link.click();
}

// Kept for your future use; currently not used by the new UI.
function populateCenterList() {
  const list = document.getElementById('centerList');
  if (!list) return;
  const names = new Set(
    Array.from(document.querySelectorAll('table tbody tr td:nth-child(2)'))
      .map(td => td.textContent.trim())
      .filter(Boolean)
  );
  list.innerHTML = '';
  names.forEach(n => {
    const opt = document.createElement('option');
    opt.value = n;
    list.appendChild(opt);
  });
}
function wireCenterSearch() {
  const input = document.getElementById('centerSearch');
  if (!input) return;
  const rows = Array.from(document.querySelectorAll('table tbody tr'));
  input.addEventListener('input', () => {
    const q = input.value.trim().toLowerCase();
    rows.forEach(row => {
      const name = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
      row.style.display = q === '' || name.includes(q) ? '' : 'none';
    });
  });
}


function saveConfig() {
  if (confirm("Do you want to save the changes?")) {
    // here you can send `batches` to server via fetch/ajax if needed
    console.log("Config saved!", batches);
    alert("Configuration saved successfully!");
  }
}




function buildMdsrTable() {
  const tb = document.getElementById('mdsrTbody');
  if (!tb) return;
  tb.innerHTML = '';

  for (let i = 1; i <= 15; i++) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="text-muted text-center">${i}</td>
      <td class="text-center">
        <input type="checkbox" name="mdsr_core_${i}" value="enabled">
      </td>
    `;
    tb.appendChild(tr);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  // your other DOMContentLoaded logic...
  buildMdsrTable();
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
